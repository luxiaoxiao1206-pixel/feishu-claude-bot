# 飞书机器人权限配置检查清单

## 🔐 必需的 API 权限

请确保在 [飞书开放平台](https://open.feishu.cn/app) 中已为你的应用开通以下权限：

### 1. 消息与群组权限

| 权限名称 | 权限标识 | 用途 | 是否必需 |
|---------|---------|------|---------|
| 获取与发送单聊、群组消息 | `im:message` | 接收和发送消息 | ✅ 必需 |
| 以应用的身份发消息 | `im:message:send_as_bot` | 机器人发送消息 | ✅ 必需 |
| 读取用户发给机器人的单聊消息 | `im:message.p2p:readonly` | 接收私聊消息 | ✅ 必需 |
| 获取群组中所有消息 | `im:message.group_at_msg:readonly` | 接收群聊@消息 | ✅ 必需 |
| 接收群聊中@机器人消息事件 | `im:message.group_at_msg` | 群聊@事件 | ✅ 必需 |
| **获取消息中的资源文件** | `im:resource` | **下载图片、文件** | ✅ **必需** |

### 2. 文档权限

| 权限名称 | 权限标识 | 用途 | 是否必需 |
|---------|---------|------|---------|
| 查看、评论和导出文档 | `docx:document` | 读取飞书文档 | ⚠️ 可选 |
| 查看和下载云空间中所有文件 | `drive:drive` | 访问云文档 | ⚠️ 可选 |
| 查看、评论、编辑和管理多维表格 | `bitable:app` | 访问多维表格 | ⚠️ 可选 |

### 3. 通讯录权限

| 权限名称 | 权限标识 | 用途 | 是否必需 |
|---------|---------|------|---------|
| 获取通讯录基本信息 | `contact:user.base:readonly` | 获取用户信息 | ⚠️ 可选 |
| 获取群组信息 | `im:chat:readonly` | 获取群聊信息 | ⚠️ 可选 |

---

## ✅ 权限配置步骤

### Step 1: 登录飞书开放平台
1. 访问 [https://open.feishu.cn/app](https://open.feishu.cn/app)
2. 选择你的应用

### Step 2: 添加权限
1. 进入 **权限管理** 页面
2. 点击 **添加权限**
3. 搜索并添加以下权限（最重要）：
   - ✅ `im:message`
   - ✅ `im:message:send_as_bot`
   - ✅ `im:message.p2p:readonly`
   - ✅ `im:message.group_at_msg:readonly`
   - ✅ **`im:resource`** ← **新增的图片下载权限**

### Step 3: 申请权限（如需要）
- 某些权限需要企业管理员审批
- 在权限列表中找到 **待审批** 的权限
- 联系管理员进行审批

### Step 4: 版本发布
1. 进入 **版本管理与发布** 页面
2. 创建新版本
3. 提交审核
4. 发布到企业

---

## 🧪 测试图片分析功能

### 测试前确认
- ✅ 权限已配置：`im:resource`
- ✅ 代码已部署：最新版本（包含 API 修复）
- ✅ 应用已发布：版本生效

### 测试步骤
1. **发送新图片**（不要问之前的图片）
2. **观察机器人回复**：
   ```
   ✅ 图片已分析完成！

   [详细的图片内容分析]

   💡 你可以继续向我提问关于这张图片的内容。
   ```
3. **后续提问测试**：
   - "图片中有什么文字？"
   - "这张图片是什么意思？"
   - "帮我总结图片内容"

### 常见问题排查

#### 问题 1: 403 Forbidden - 权限不足
```
❌ 下载图片失败: 403 Forbidden
```
**解决方案**：检查 `im:resource` 权限是否已添加并生效

#### 问题 2: 404 Not Found - 消息或资源不存在
```
❌ 下载图片失败: 404 Not Found
```
**解决方案**：确认 message_id 和 image_key 是否正确

#### 问题 3: 机器人无响应
**可能原因**：
- Render 部署未完成
- 代码未更新到最新版本
- 事件订阅配置错误

**解决方案**：
- 检查 Render Dashboard 部署状态
- 重新部署最新代码
- 查看服务器日志

---

## 📊 权限验证命令（可选）

如果你有飞书 App Token，可以通过以下 API 测试权限：

```bash
# 测试下载图片权限
curl -X GET \
  'https://open.feishu.cn/open-apis/im/v1/messages/{message_id}/resources/{file_key}?type=image' \
  -H 'Authorization: Bearer {APP_ACCESS_TOKEN}'
```

---

## 🎯 关键修复说明

### 修复内容
- **API 调用路径修正**：`feishuClient.im.message.resource` → `feishuClient.im.messageResource.get`
- **符合飞书官方文档**：使用正确的语义化方法名

### 影响范围
- 图片下载功能现在应该可以正常工作
- 所有权限配置正确后，图片分析将自动进行

---

**生成时间**: 2025-12-15
**文档版本**: 1.0
